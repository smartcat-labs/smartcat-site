<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js ie6"> <![endif]-->
<!--[if IE 7]>         <html class="no-js ie7"> <![endif]-->
<!--[if IE 8]>         <html class="no-js ie8"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
		<link href="favicon.ico" rel="icon" />
		<title>SmartCat | Setting up embedded cassandra on spring project</title>
		<meta name="description" content="">
		<meta name="viewport" content="width=device-width, initial-scale=1">

		<link rel="stylesheet" href="assets/css/style.css">
		<link rel="stylesheet" type="text/css" href="rs-plugin/css/settings.css" media="screen" />

		<script type="text/javascript" src="assets/scripts/libs/modernizr-2.6.2.min.js"></script>
	</head>
<body>

	<div class="container">
		<header class="header">
			<div class="wrapper">
				<a href="index.html" class="logo">
					<img src="assets/img/logo.png" alt="" />
				</a>

				<div class="search-desktop">
					<div class="search-wrapper">
						<a href="javascript:;" class="btn-search">
							<i class="ico"></i>
						</a>
						<input type="search" placeholder="Search">
					</div>
					
					<a href="javascript:;" class="open-search">
						<i class="ico"></i>
					</a>
				</div>

				<ul class="social">
					<li>
						<a href="http://www.github.com" target="_blank"><i class="ico github"></i></a>
					</li>
					<li>
						<a href="http://www.twitter.com" target="_blank"><i class="ico twitter"></i></a>
					</li>
					<li>
						<a href="http://www.stackoverflow.com" target="_blank"><i class="ico stackoverflow"></i></a>
					</li>
					<li>
						<a href="http://www.linkedin.com" target="_blank"><i class="ico linked"></i></a>
					</li>
				</ul>
				<a href="tel:+381216616557" class="phone">+381 (0)21 661 65 57</a>
				<div class="menu-wrapper">
					<nav class="main-nav">
						<a href="javascript:;" class="close-menu">
							<i class="ico"></i>
						</a>
						<ul>
							<li>
								<a href="services.html">Services</a>
							</li>
							<li>
								<a href="technologies.html">
									<span class="t-desktop">Technologies</span>
									<span class="t-desktop-small">Techs</span>
								</a>
							</li>
							<li>
								<a href="process.html">Process</a>
							</li>
							<li>
								<a href="team.html">Team</a>
							</li>
							<li>
								<a href="blog.html" class="active">
									<i class="ico cat"></i>
									<strong>Blog</strong>
								</a>
							</li>
							<li>
								<a href="news.html">News</a>
							</li>
							<li>
								<a href="contact.html">Contact</a>
							</li>
						</ul>
						<div class="search-box">
							<input type="text">
							<a href="javascript:;" class="search-btn">
								<i class="ico"></i>
							</a>
						</div>
					</nav>
				</div>
				<a href="javascript:;" class="menu-btn"><i class="ico"></i></a>
			</div>
		</header>
		
		<div class="page-title">
			<div class="wrapper">
				<h1>Blog</h1>
			</div>
		</div>
		
		<div class="content">
			<div class="wrapper o-visible">
				<div class="main article">
					<div class="title">
						<h2>Setting up embedded cassandra on spring project</h2>
						<a href="blog.html" class="go-back">Back</a>
						<span class="date">23/07/15</span>
					</div>
					<div class="img-wrap">
						<img src="assets/img/content/setting-up-embedded-cassandra-with-spring.jpg" alt="" />
						<div class="badge romb"><span class="reset-inner">B.</span></div>
					</div>
					<div class="rte-content">
						<p>
							When we first started using cassandra, we immediately realized there would be a long period of development and prototyping until we reach the stable repository classes we would use. It was a new technology, client demands were changing constantly (in cassandra you do query based modeling which means our repository classes changed as well) and we needed to build up confidence that we are doing right thing. We needed a tool which will give us fast feedback using production-like database setup without starting server, doing API triggers and checking what had landed in our database.  
						</p>
						<p>
							<a href="https://github.com/jsevellec/cassandra-unit" target="_blank">Cassandra unit</a>  gave us exactly what we needed, which was a java utility test tool providing us with an ability to test drive our repository and schema models according to the requirements. Basically, it starts embedded cassandra before test methods, has the ability to create structure and allows the developer to run cql queries against production-like database without constantly starting the application, and without the need to have full API designed. We have decided to go with Datastax driver, so Cassandra Unit enabled us to explore driver API in TDD manner. We receive the requirement, write the integration test using connected Session to Embedded Cassandra and start implementing until we see it turn green. 
						</p>
						<p>
							Setup in spring project and cleaning up the database between tests took quite an effort. We did this in a couple of steps. First, we created <em>TestCassandraConfiguration</em> which is plain Spring configuration class for active profile tests, and it creates the necessary beans and initializes Embedded Cassandra. The main thing here is to create a Session bean which we can use in other test methods to connect to our database.
						</p>
<pre class="csharpcode">
 @Bean
    <span class="kwrd">public</span> Session session() throws Exception {
        <span class="kwrd">if</span> (session == <span class="kwrd">null</span>) {
            initialize();
        }

        <span class="kwrd">if</span> (sessionProxy == <span class="kwrd">null</span>) {
            sessionProxy = <span class="kwrd">new</span> SessionProxy(session);
        }

        <span class="kwrd">return</span> sessionProxy;
    }
</pre>
					    <p>
					    	For now, we will ignore the <em>SessionProxy</em> thing, which will be explained later. If we do not have Session defined, initialize() method will start Embedded Cassandra, create a cluster and initialize table structure and connect to it. Here is the initialize method as well:
					    </p>
<pre class="csharpcode">
	<span class="kwrd">private</span> <span class="kwrd">void</span> initialize() throws Exception {
        LOGGER.info(<span class="str">"Starting embedded cassandra server"</span>);
        EmbeddedCassandraServerHelper.startEmbeddedCassandra(<span class="str">"another-cassandra.yaml"</span>);

        LOGGER.info(<span class="str">"Connect to embedded db"</span>);
        cluster = Cluster.builder().addContactPoints(contact_points).withPort(port).build();
        session = cluster.connect();

        LOGGER.info(<span class="str">"Initialize keyspace"</span>);
        final CQLDataLoader cqlDataLoader = <span class="kwrd">new</span> CQLDataLoader(session);
        cqlDataLoader.load(<span class="kwrd">new</span> ClassPathCQLDataSet(CQL, <span class="kwrd">false</span>, <span class="kwrd">true</span>, keyspace));
    }
</pre>
					    <p>
					    	We created this configuration as DisposableBean implementation which enabled us to use the destroy() method for total cleanup. The complete example with all details of the configuration file [link to file] can be found on our github account, showing how to wire everything up. It is a part of our Spring showcase for <a href="https://github.com/smartcat-labs/cassandra-migration-tool-java" target="_blank">cassanadra schema migration</a> tool we had created. 
					    </p>
					    <p>
					    	The second step is creating a listener which can be used on classes which need embedded cassandra. This listener is implementing <em>AbstractTestExecutionListener</em> and is responsible for cleanup between tests. It has <em>afterTestMethod()</em> which is doing cleanup.
					    </p>
<pre class="csharpcode">
@Override
<span class="kwrd">public</span> <span class="kwrd">void</span> afterTestMethod(final TestContext testContext) throws Exception {
    LOGGER.debug(<span class="str">"AfterTest: clean embedded cassandra"</span>);
    final Session session = (Session) TestApplicationContext.getBean(<span class="str">"session"</span>);
    <span class="kwrd">for</span> (final String table : tables(session)) {
        session.execute(String.format(<span class="str">"TRUNCATE %s.%s;"</span>, KEYSPACE, table));
    }
    super.afterTestMethod(testContext);
}
</pre>
					    <p>
					    	Nothing special here, for all tables we have in cluster metadata which we are fetching from session we perform truncate, so we can have a clean state before the next test. The complete details of this listener can be seen at [link here]. An important middle step in the communication between listener and configuration class is to create <em>TestApplicationContext</em> which will hold the beans defined in configuration and which can be used to access the Session bean.
					    </p>
					    <p>
					    	The last step was loading this listener on each test method, and that was it, we had embedded cassandra working and our Session connected to it injected in all repository classes instead of the production Session which would be created from production code and would be connected to production cassandra cluster.

					    </p>
<pre class="csharpcode">
 @TestExecutionListeners({CassandraTestExecutionListener.<span class="kwrd">class</span>,
     DependencyInjectionTestExecutionListener.<span class="kwrd">class</span>})
  <span class="kwrd">public</span> <span class="kwrd">class</span> SomeRepositoryTest {
      …..
  }</pre>
					  	<p>
					  		Back to the <em>SessionProxy</em> thing. This was an another tweak we did. With cassandra we used executeAsync() as much as we could; whenever we didn’t need response immediately, we used it. The problem was to test this. First, we took the Thread.sleep() road and added pauses all over our tests to be sure something would be written in order to read and verify it. That slowed our test suite a lot and was not a particular solution since there were no guarantees write will finish in sleep amount of seconds. We stubbed ResultSetFuture which was a result of executeAsync() method on Session and created a proxy on top of Session which would override executeAsync() to work as regular execute. As a result, we got synchronous executions even when our repository method used executeAsync (only in tests of course) which made our life easier while testing. We did not have to worry anymore if the results are written and how long should we pause the execution. Details can also be seen here [link here].
					  	</p>
					  	<p>
					  		To sum it all up. Cassandra is not new to us anymore, but we still like to have repository classes integration tested against production cassandra like environment. Cassandra is known for its schema which evolves, modeling decisions must be revisited occasionally, so this gives us confidence that we can refactor and change. Also, performing tests this way has provided us a lot of insights into driver API much faster because we can now play with API and see the results right away. Last, but not the least, we are starting our backend applications much less often when we are developing database models, which significantly speeds up the development.

					  	</p>
					</div>
					<div class="article-nav">
						<a href="migrating-time.html" class="prev-post">
							<i></i>
							Previus post
						</a>
						<a href="leveraging-parallel-execution.html" class="next-post">
							Next post
							<i></i>
						</a>
					</div>
					<div class="article-footer">
						<div class="share-box">
							<span>Share</span>
							<ul>
								 <li>
								 	<a href="https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fsmartcat.io&t=" target="_blank" title="Share on Facebook" onclick="window.open('https://www.facebook.com/sharer/sharer.php?u=' + encodeURIComponent(document.URL) + '&t=' + encodeURIComponent(document.URL)); return false;">FB</a>
							 	</li>
							  	<li>
							  		<a href="https://twitter.com/intent/tweet?source=http%3A%2F%2Fsmartcat.io&text=:%20http%3A%2F%2Fsmartcat.io" target="_blank" title="Tweet" onclick="window.open('https://twitter.com/intent/tweet?text=' + encodeURIComponent(document.title) + ':%20'  + encodeURIComponent(document.URL)); return false;">TW</a>
						  		</li>
							  	<li>
							  		<a href="https://plus.google.com/share?url=http%3A%2F%2Fsmartcat.io" target="_blank" title="Share on Google+" onclick="window.open('https://plus.google.com/share?url=' + encodeURIComponent(document.URL)); return false;">G+</a>
						  		</li>
							  	<li>
							  		<a href="http://www.linkedin.com/shareArticle?mini=true&url=http%3A%2F%2Fsmartcat.io&title=&summary=&source=http%3A%2F%2Fsmartcat.io" target="_blank" title="Share on LinkedIn" onclick="window.open('http://www.linkedin.com/shareArticle?mini=true&url=' + encodeURIComponent(document.URL) + '&title=' +  encodeURIComponent(document.title)); return false;">IN</a>
						  		</li>
							</ul>
						</div>
					</div>
					
					<div class="author-box">
						<img src="assets/img/content/home-bojan.png"  alt="" class="hidden-on-mobile" />
						<div class="info">
							<h4><span>Bojan Kovac</span></h4>
							<h5>Co-Founder</h5>
							<p>
								A computer science graduate with over 10 years of experience managing software projects and product development while leading organizational changes towards operational maturity and efficiency.
							</p>
							<div class="bottom">
								<a href="mailto:bojan.kovac@smartcat.io" class="contact-link">
									<i class="ico ico-mail"></i> Contact Bojan
								</a>
								<ul class="social-links">
									<li>
										<a href="https://rs.linkedin.com/in/bojankovac" target="_blank" class="linked"><i class="ico"></i></a>
									</li>
								</ul>
							</div>
						</div>
					</div>
				</div>
				<aside class="sidebar">
					<div class="widget slider">
						<h3><a href="news.html">What's new</a></h3>
						<div class="flexslider">
							<ul class="slides">
								<li>
									<div class="text-item">
										<div class="romb badge">
											<span class="reset-inner">N.</span>
										</div>
										<h4><a href="why-smartcat.html">Why SmartCat?</a></h4>
										<p>
											The concept of Big Data has intrigued us from the very first online articles describing this new frontier of technology, back in 2007. Imagine if we could know...
										</p>
										<span class="author">Nenad Bozic</span>
										<span class="date">24/07/15</span>
									</div>
								</li>
								<li>
									<div class="text-item">
										<div class="romb badge">
											<span class="reset-inner">N.</span>
										</div>
										<h4><a href="cassandra-summit.html">Cassandra summit 2015</a></h4>
										<p>
											We are excited for the upcoming Cassandra Summit in San Francisco, the biggest NoSQL conference in the world and epicenter of Cassandra...
										</p>
										<span class="author">Matija Gobec</span>
										<span class="date">30/07/15</span>
									</div>
								</li>
								<li>
									<div class="text-item">
										<div class="romb badge">
											<span class="reset-inner">N.</span>
										</div>
										<h4><a href="coding-serbia.html">Coding Serbia</a></h4>
										<p>
											We would like to share our excitement with you. This October we will be a part of the 3rd international Coding Serbia conference in Novi Sad as silver...
										</p>
										<span class="author">Bojan Kovac</span>
										<span class="date">05/08/15</span>
									</div>
								</li>
							</ul>
						</div>
					</div>
					<div class="widget slider">
						<h3><a href="team.html">Challengers</a></h3>
						<div class="flexslider challengers">
							<ul class="slides">
								<li>
									<div class="inner">
										<img src="assets/img/content/sidebar-bojan.png">
										<div class="author-info">
											<h4>Bojan Kovac</h4>
											<span>Co-Founder</span>
										</div>
									</div>
								</li>
								<li>
									<div class="inner">
										<img src="assets/img/content/sidebar-matija.png">
										<div class="author-info">
											<h4>Matija Gobec</h4>
											<span>Co-Founder</span>
										</div>
									</div>
								</li>
								<li>
									<div class="inner">
										<img src="assets/img/content/sidebar-nenad.png">
										<div class="author-info">
											<h4>Nenad Bozic</h4>
											<span>Co-Founder</span>
										</div>
									</div>
								</li>
							</ul>
						</div>
					</div>
					<div class="widget slider">
						<h3><a href="services.html">What we do</a></h3>
						<div class="flexslider small">
							<ul class="slides">
								<li>
									<div class="center">
										<img src="assets/img/content/data-architecture-slider.png">
										<h4><a href="architecture.html">Architecture</a></h4>
									</div>
								</li>
								<li>
									<div class="center">
										<img src="assets/img/content/data-storage-slider.png">
										<h4><a href="data-storage.html">Data storage</a></h4>
									</div>
								</li>
								<li>
									<div class="center">
										<img src="assets/img/content/data-analytics-slider.png">
										<h4><a href="data-processing.html">Data processing</a></h4>
									</div>
								</li>
								<li>
									<div class="center">
										<img src="assets/img/content/data-analytics-slider.png">
										<h4><a href="data-analytics.html">Data analytics</a></h4>
									</div>
								</li>
							</ul>
						</div>
					</div>
				</aside>
			</div>
		</div>
		
		<footer class="footer">
			<section class="top">
				<img src="assets/img/star-texture.png" alt=""/>
				<div class="wrapper">
					<h2>Want to work with us?</h2>
					<p>
						Want to see what SmartCat can do for your business? <br> We can't wait to show you! Provide us your info in the field below.
					</p>
				</div>
			</section>
			
			<div class="contact-block">
				<div class="wrapper">
					<h4>Contact us</h4>
					<form id="theForm" class="simform" autocomplete="off">
						<div class="simform-inner">
							<ol class="questions">
								<li>
									<span><label for="q1">What's your name? <span>(Please fill the field before continuing)</span></label></span>
									<input id="q1" name="q1" type="text"/>
								</li>
								<li>
									<span><label for="q2">Where do you live?</label></span>
									<input id="q2" name="q2" type="text"/>
								</li>
								<li>
									<span><label for="q3">What time do you got to work?</label></span>
									<input id="q3" name="q3" type="text"/>
								</li>
								<li>
									<span><label for="q4">How do you like your veggies?</label></span>
									<input id="q4" name="q4" type="text"/>
								</li>
								<li>
									<span><label for="q5">What book inspires you?</label></span>
									<input id="q5" name="q5" type="text"/>
								</li>
								<li>
									<span><label for="q6">What's your profession?</label></span>
									<input id="q6" name="q6" type="text"/>
								</li>
							</ol><!-- /questions -->
							<button class="submit" type="submit">Send answers</button>
							<div class="controls">
								<button class="next"></button>
								<div class="progress"></div>
								<span class="number">
									<span class="number-current"></span>
									<span class="number-total"></span>
								</span>
								<span class="error-message"></span>
							</div><!-- / controls -->
						</div><!-- /simform-inner -->
						<span class="final-message"></span>
					</form>
					<ul class="social show-on-mobile">
						<li>
							<a href="https://github.com/smartcat-labs" class="ico github" target="_blank"></a>
						</li>
						<li>
							<a href="javascript:;" class="ico twitter"></a>
						</li>
						<li>
							<a href="javascript:;" class="ico stackoverflow"></a>
						</li>
						<li>
							<a href="javascript:;" class="ico linked"></a>
						</li>
					</ul>
					<a href="javascript:;" class="scroll-top show-on-mobile"></a>
				</div>
			</div>
			
			<div class="bottom">
				<div class="wrapper">
					<div class="left">
						<a href="index.html" class="logo">
							<img src="assets/img/footer-logo.png" alt="" />
						</a>
						<p>
							&copy;SmartCat 2015.All rights reserved. Design by <a href="http://www.weareelder.com" target="_blank">Elder</a>.
						</p>
					</div>
					<ul class="info-list">
						<li>	
							<span>
								<i class="ico pin"></i>
								Danila Kiša 3V/14, Novi Sad, 21000, Serbia
							</span>
						</li>
						<li>	
							<a href="tel:+381216616557">
								<i class="ico telephone"></i>
								+381 (0)21 661 65 57
							</a>
						</li>
						<li>	
							<a href="mailto:info@smartcat.io">
								<i class="ico mail"></i>
								info@smartcat.io
							</a>
						</li>
					</ul>
				</div>
			</div>			
		</footer>
	</div>

<!-- javascript -->

<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
<script type="text/javascript">window.jQuery || document.write("<script src='assets/scripts/main/jquery-1.8.3.min.js'>\x3C/script>")</script>
<script type="text/javascript" src="assets/scripts/libs/classie.js"></script>
<script type="text/javascript" src="assets/scripts/libs/stepsForm.js"></script>
<script type="text/javascript" src="assets/scripts/libs/jquery.flexslider-min.js"></script>

<script type="text/javascript" src="assets/scripts/main/default.js"></script>

 <!--[if lt IE 7]>
    <p class="browsehappy">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</p>
<![endif]-->

</body>
</html>
